image: mingc/android-build-box:latest

definitions:
  caches:
    nodecustom: ./node_modules
    yarn: /usr/local/share/.cache/yarn

pipelines:
  default:
    - step:
        name: Backoffice lint and type checks
        caches:
          - nodecustom
          - yarn
          - gradle
        script:
          - cd supabase
          - yarn install
          - yarn supabase-configs-backoffice true
          - cd ../BackofficeCMS

    - step:
        name: 'Deployment of Backoffice web app to preview'
        caches:
          - nodecustom
          - yarn
          - gradle
        deployment: Staging
        script:
          - cd supabase
          - yarn install
          - yarn supabase-configs
          - cd ../BackofficeCMS
          - yarn install
          - npm install --global vercel
          - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
          - vercel build --token=$VERCEL_TOKEN
          - vercel deploy --prebuilt  --token=$VERCEL_TOKEN

  branches:
    main:
      - step:
          name: 'Deployment of Backoffice web app to staging'
          caches:
            - nodecustom
            - yarn
            - gradle
          deployment: Staging
          script:
            - cd supabase
            - yarn install
            - yarn supabase-configs-backoffice
            - npx supabase link --project-ref $SUPABASE_PROJECT_ID
            - npx supabase db push
            - cd ../BackofficeCMS
            - yarn install
            - npm install --global vercel
            - vercel pull --yes --token=$VERCEL_TOKEN
            - vercel build --prod --token=$VERCEL_TOKEN
            - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
            - cd ../RNMobileApp/android
            - chmod +x gradlew
            - ./gradlew assembleRelease

      - step:
          name: 'Deployment of Backoffice web app to production'
          caches:
            - nodecustom
            - yarn
            - gradle
          deployment: Production
          trigger: 'manual'
          script:
            - cd supabase
            - yarn install
            - yarn supabase-configs-backoffice
            - npx supabase link --project-ref $SUPABASE_PROJECT_ID
            - npx supabase db push
            - cd ../BackofficeCMS
            - yarn install
            - npm install --global vercel
            - vercel pull --yes --environment=production --token=$VERCEL_TOKEN
            - vercel build --prod --token=$VERCEL_TOKEN
            - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
