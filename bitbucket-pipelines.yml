image: node:18

definitions:
  caches:
    yarn: /usr/local/share/.cache/yarn
    gradle: ~/.gradle/caches
    gradle-wrapper: ~/.gradle/wrapper
    node: /usr/local/lib/node_modules
    bundler: /var/lib/gems
  steps:
    - step: &backoffice-linting
        name: Backoffice lint and type checks
        condition:
          changesets:
            includePaths:
              - "BackofficeCMS/**"
        caches:
          - yarn
        script:
          - cd supabase
          - yarn install --frozen-lockfile
          - yarn supabase-configs-backoffice true
          - cd ../BackofficeCMS
          - yarn install --frozen-lockfile
          - yarn type-check
          - yarn lint

    - step: &mobile-app-linting-tests
        name: Mobile app lint, type checks and tests
        condition:
          changesets:
            includePaths:
              - "RNMobileApp/**"
        caches:
          - yarn
        script:
          - cd supabase
          - yarn install --frozen-lockfile
          - yarn supabase-configs-mobile true
          - cd ../RNMobileApp
          - yarn install --frozen-lockfile
          - yarn type-check
          - yarn lint
          - yarn test

pipelines:
  pull-requests:
    '**':
      - parallel:
          steps:
            - step: *backoffice-linting
            - step: *mobile-app-linting-tests

      - parallel:
        - step:
            name: 'Deployment of Backoffice web app to preview'
            condition:
              changesets:
                includePaths:
                  - "BackofficeCMS/**"
            caches:
              - yarn
              - node
            deployment: backoffice-preview
            script:
              - source ./pipelines/executables/setup-backoffice-staging-env.sh
              - export VITE_SENTRY_ENVIRONMENT=preview-$BITBUCKET_BRANCH
              - source ./pipelines/executables/setup-backoffice-build.sh
              - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
              - vercel build --token=$VERCEL_TOKEN
              - vercel deploy --prebuilt --token=$VERCEL_TOKEN

        - step:
            name: 'Deployment of Android App to preview'
            condition:
              changesets:
                includePaths:
                  - "RNMobileApp/**"
            max-time: 30
            caches:
              - yarn
              - gradle
              - gradle-wrapper
              - bundler
              - node
            deployment: android-preview
            trigger: manual
            image: reactnativecommunity/react-native-android:latest
            size: 2x
            script:
              - source ./pipelines/executables/setup-android-build.sh
              - cd RNMobileApp
              - echo "VERSION_NAME=preview-$BITBUCKET_BRANCH-$BITBUCKET_COMMIT" >> .env
              - echo "SENTRY_ENVIRONMENT=preview-$BITBUCKET_BRANCH" >> .env
              - cd ..
              - source ./pipelines/executables/android-build-and-deploy.sh

        - step:
            name: 'Deployment of IOS App to preview'
            condition:
              changesets:
                includePaths:
                  - "RNMobileApp/**"
            runs-on:
              - self.hosted
              - macos
            deployment: ios-preview
            trigger: manual
            script:
              - export APP_TEST_FLIGHT_CHANGE_LOG='Preview app from branch $BITBUCKET_BRANCH and commit $BITBUCKET_COMMIT, build $BITBUCKET_BUILD_NUMBER'
              - source ./pipelines/executables/setup-ios-build.sh
              - cd RNMobileApp
              - echo "SENTRY_ENVIRONMENT=preview-$BITBUCKET_BRANCH" >> .env
              - cd ..
              - source ./pipelines/executables/ios-build-and-deploy.sh

  branches:
    main:
      - parallel:
          steps:
            - step: *backoffice-linting
            - step: *mobile-app-linting-tests

      - parallel:
        - step:
            name: 'Deployment of supabase changes to staging'
            caches:
              - yarn
              - node
            deployment: supabase-staging
            script:
              - source ./pipelines/executables/supabase-db-push.sh

        - step:
            name: 'Deployment of Backoffice web app to staging'
            condition:
              changesets:
                includePaths:
                  - "BackofficeCMS/**"
            caches:
              - yarn
              - node
            deployment: backoffice-staging
            script:
              - source ./pipelines/executables/setup-backoffice-staging-env.sh
              - source ./pipelines/executables/setup-backoffice-build.sh
              - vercel pull --yes --environment=production --token=$VERCEL_TOKEN
              - vercel build --prod --token=$VERCEL_TOKEN
              - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

        - step:
            name: 'Deployment of Android App to staging'
            condition:
              changesets:
                includePaths:
                  - "RNMobileApp/**"
            max-time: 30
            caches:
              - yarn
              - gradle
              - gradle-wrapper
              - bundler
              - node
            deployment: android-staging
            image: reactnativecommunity/react-native-android:latest
            size: 2x
            script:
              - source ./pipelines/executables/setup-android-build.sh
              - cd RNMobileApp
              - echo "VERSION_NAME=$BITBUCKET_COMMIT" >> .env
              - echo "SENTRY_ENVIRONMENT=staging" >> .env
              - cd ..
              - source ./pipelines/executables/android-build-and-deploy.sh

        - step:
            name: 'Deployment of IOS App to staging'
            condition:
              changesets:
                includePaths:
                  - "RNMobileApp/**"
            runs-on:
              - self.hosted
              - macos
            deployment: ios-staging
            script:
              - export APP_TEST_FLIGHT_CHANGE_LOG='Staging app from main and commit $BITBUCKET_COMMIT, build $BITBUCKET_BUILD_NUMBER'
              - source ./pipelines/executables/setup-ios-build.sh
              - cd RNMobileApp
              - echo "SENTRY_ENVIRONMENT=staging" >> .env
              - cd ..
              - source ./pipelines/executables/ios-build-and-deploy.sh

      - parallel:
        - step:
            name: 'Deployment of supabase changes to production'
            caches:
              - yarn
              - node
            deployment: supabase-production
            trigger: manual
            script:
              - source ./pipelines/executables/supabase-db-push.sh

        - step:
            name: 'Deployment of Backoffice web app to production'
            condition:
              changesets:
                includePaths:
                  - "BackofficeCMS/**"
            caches:
              - yarn
              - node
            deployment: backoffice-production
            trigger: manual
            script:
              - source ./pipelines/executables/setup-backoffice-production-env.sh
              - source ./pipelines/executables/setup-backoffice-build.sh
              - vercel pull --yes --environment=production --token=$VERCEL_TOKEN
              - vercel build --prod --token=$VERCEL_TOKEN
              - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

        - step:
            name: 'Deployment of Android App to production'
            condition:
              changesets:
                includePaths:
                  - "RNMobileApp/**"
            max-time: 30
            caches:
              - yarn
              - gradle
              - gradle-wrapper
              - bundler
              - node
            deployment: android-production
            trigger: manual
            image: reactnativecommunity/react-native-android:latest
            size: 2x
            script:
              - source ./pipelines/executables/setup-android-build.sh
              - cd RNMobileApp
              - echo "VERSION_NAME=$BITBUCKET_COMMIT" >> .env
              - echo "SENTRY_ENVIRONMENT=production" >> .env
              - cd ..
              - source ./pipelines/executables/android-build-and-deploy.sh

        - step:
            name: 'Deployment of IOS App to production'
            condition:
              changesets:
                includePaths:
                  - "RNMobileApp/**"
            runs-on:
              - self.hosted
              - macos
            deployment: ios-production
            trigger: manual
            script:
              - export APP_TEST_FLIGHT_CHANGE_LOG='Production app from main and commit $BITBUCKET_COMMIT, build $BITBUCKET_BUILD_NUMBER'
              - source ./pipelines/executables/setup-ios-build.sh
              - cd RNMobileApp
              - echo "SENTRY_ENVIRONMENT=production" >> .env
              - cd ..
              - source ./pipelines/executables/ios-build-and-deploy.sh
