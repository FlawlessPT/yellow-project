image: node:18

definitions:
  caches:
    yarn: /usr/local/share/.cache/yarn
    gradle: ~/.gradle/caches
    gradle-wrapper: ~/.gradle/wrapper
    node: /usr/local/lib/node_modules

pipelines:
  default:
    - step:
        name: Backoffice lint and type checks
        caches:
          - yarn
        script:
          - cd supabase
          - yarn install --frozen-lockfile
          - yarn supabase-configs-backoffice true
          - cd ../BackofficeCMS
          - yarn install --frozen-lockfile
          - yarn type-check
          - yarn lint

    - step:
        name: 'Deployment of Backoffice web app to preview'
        caches:
          - yarn
          - node
        deployment: Staging
        script:
          - cd supabase
          - yarn install --frozen-lockfile
          - yarn supabase-configs
          - cd ../BackofficeCMS
          - yarn install --frozen-lockfile
          - npm install --global vercel
          - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
          - vercel build --token=$VERCEL_TOKEN
          - vercel deploy --prebuilt  --token=$VERCEL_TOKEN

  branches:
    main:
      - step:
          name: 'Deployment of Backoffice web app to staging'
          caches:
            - yarn
            - node
          deployment: Staging
          script:
            - cd supabase
            - yarn install --frozen-lockfile
            - yarn supabase-configs-backoffice
            - npx supabase link --project-ref $SUPABASE_PROJECT_ID
            - npx supabase db push
            - cd ../BackofficeCMS
            - yarn install --frozen-lockfile
            - npm install --global vercel
            - vercel pull --yes --token=$VERCEL_TOKEN
            - vercel build --prod --token=$VERCEL_TOKEN
            - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

      - step:
          name: 'Deployment of Android App to staging'
          max-time: 15
          caches:
            - yarn
            - gradle
            - gradle-wrapper
            - node
          deployment: android-staging
          trigger: 'manual'
          image: reactnativecommunity/react-native-android:latest
          size: 2x
          artifacts:
            - RNMobileApp/android/app/build/outputs/**
          script:
            - cd supabase
            - yarn install --frozen-lockfile
            - yarn supabase-configs-mobile
            - cd ../RNMobileApp
            - yarn install --frozen-lockfile
            - cd android && chmod +x gradlew
            - ./gradlew assembleRelease
            - npm install -g appcenter-cli
            - appcenter distribute release --app $APP_CENTER_PROJECT --file ./app/build/outputs/apk/release/app-release.apk --group "Collaborators" --token $APP_CENTER_TOKEN

      - step:
          name: 'Deployment of Backoffice web app to production'
          caches:
            - yarn
            - node
          deployment: Production
          trigger: 'manual'
          script:
            - cd supabase
            - yarn install --production=true
            - yarn supabase-configs-backoffice
            - npx supabase link --project-ref $SUPABASE_PROJECT_ID
            - npx supabase db push
            - cd ../BackofficeCMS
            - yarn install --production=true
            - npm install --global vercel
            - vercel pull --yes --environment=production --token=$VERCEL_TOKEN
            - vercel build --prod --token=$VERCEL_TOKEN
            - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
