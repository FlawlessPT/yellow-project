image: node:18

definitions:
  caches:
    yarn: /usr/local/share/.cache/yarn
    gradle: ~/.gradle/caches
    gradle-wrapper: ~/.gradle/wrapper
    node: /usr/local/lib/node_modules
    bundler: /var/lib/gems
  steps:
    - step: &backoffice-linting
        name: Backoffice lint and type checks
        condition:
          changesets:
            includePaths:
              - "BackofficeCMS/**"
        caches:
          - yarn
        script:
          - cd supabase
          - yarn install --frozen-lockfile
          - yarn supabase-configs-backoffice true
          - cd ../BackofficeCMS
          - yarn install --frozen-lockfile
          - yarn type-check
          - yarn lint

    - step: &mobile-app-linting
        name: Mobile app lint and type checks
        condition:
          changesets:
            includePaths:
              - "RNMobileApp/**"
        caches:
          - yarn
        script:
          - cd supabase
          - yarn install --frozen-lockfile
          - yarn supabase-configs-mobile true
          - cd ../RNMobileApp
          - yarn install --frozen-lockfile
          - yarn type-check
          - yarn lint

pipelines:
  pull-requests:
    '**':
      - parallel:
          steps:
            - step: *backoffice-linting
            - step: *mobile-app-linting

      - step:
          name: 'Deployment of Backoffice web app to preview'
          condition:
            changesets:
              includePaths:
                - "BackofficeCMS/**"
          caches:
            - yarn
            - node
          deployment: backoffice-staging
          script:
            - source ./pipelines/executables/setup-backoffice-staging-env.sh
            - export VITE_SENTRY_ENVIRONMENT=preview-$BITBUCKET_BRANCH
            - source ./pipelines/executables/setup-backoffice-build.sh
            - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
            - vercel build --token=$VERCEL_TOKEN
            - vercel deploy --prebuilt --token=$VERCEL_TOKEN

      - step:
          name: 'Deployment of Android App to preview'
          condition:
            changesets:
              includePaths:
                - "RNMobileApp/**"
          max-time: 30
          caches:
            - yarn
            - gradle
            - gradle-wrapper
            - bundler
            - node
          deployment: android-preview
          trigger: 'manual'
          image: reactnativecommunity/react-native-android:latest
          size: 2x
          script:
            - source ./pipelines/executables/setup-mobile-app-staging-env.sh
            - source ./pipelines/executables/setup-android-build.sh
            - cd RNMobileApp
            - echo "VERSION_NAME=preview-$BITBUCKET_BRANCH-$BITBUCKET_COMMIT" >> .env
            - echo "SENTRY_ENVIRONMENT=preview-$BITBUCKET_BRANCH" >> .env
            - cd ..
            - source ./pipelines/executables/android-build-and-deploy-staging.sh

      - step:
          name: 'Deployment of IOS App to preview'
          condition:
            changesets:
              includePaths:
                - "RNMobileApp/**"
          runs-on:
            - self.hosted
            - macos
          deployment: ios-preview
          trigger: 'manual'
          script:
            - source ./pipelines/executables/setup-mobile-app-staging-env.sh
            - export APP_TEST_FLIGHT_CHANGE_LOG='Preview app from branch $BITBUCKET_BRANCH and commit $BITBUCKET_COMMIT, build $BITBUCKET_BUILD_NUMBER'
            - source ./pipelines/executables/setup-ios-build.sh
            - echo "SENTRY_ENVIRONMENT=preview-$BITBUCKET_BRANCH" >> .env
            - source ./pipelines/executables/ios-build-and-deploy-staging.sh

  branches:
    main:
      - parallel:
          steps:
            - step: *backoffice-linting
            - step: *mobile-app-linting

      - step:
          name: 'Deployment of supabase changes to staging'
          caches:
            - yarn
            - node
          deployment: supabase-staging
          script:
            - export SUPABASE_DB_PASSWORD=$SUPABASE_DB_PASSWORD_STAGING
            - export SUPABASE_PROJECT_ID=$SUPABASE_PROJECT_ID_STAGING
            - source ./pipelines/executables/supabase-db-push.sh

      - step:
          name: 'Deployment of Backoffice web app to staging'
          condition:
            changesets:
              includePaths:
                - "BackofficeCMS/**"
          caches:
            - yarn
            - node
          deployment: backoffice-staging
          script:
            - ./pipelines/executables/setup-backoffice-staging-env.sh
            - ./pipelines/executables/setup-backoffice-build.sh
            - vercel pull --yes --token=$VERCEL_TOKEN
            - vercel build --prod --token=$VERCEL_TOKEN
            - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

      - step:
          name: 'Deployment of Android App to staging'
          condition:
            changesets:
              includePaths:
                - "RNMobileApp/**"
          max-time: 30
          caches:
            - yarn
            - gradle
            - gradle-wrapper
            - bundler
            - node
          deployment: android-staging
          image: reactnativecommunity/react-native-android:latest
          size: 2x
          script:
            - source ./pipelines/executables/setup-mobile-app-staging-env.sh
            - source ./pipelines/executables/setup-android-build.sh
            - cd RNMobileApp
            - echo "VERSION_NAME=$BITBUCKET_COMMIT" >> .env
            - echo "SENTRY_ENVIRONMENT=staging" >> .env
            - cd ..
            - source ./pipelines/executables/android-build-and-deploy-staging.sh

      - step:
          name: 'Deployment of IOS App to staging'
          condition:
            changesets:
              includePaths:
                - "RNMobileApp/**"
          runs-on:
            - self.hosted
            - macos
          deployment: ios-staging
          script:
            - source ./pipelines/executables/setup-mobile-app-staging-env.sh
            - export APP_TEST_FLIGHT_CHANGE_LOG='Staging app from main and commit $BITBUCKET_COMMIT, build $BITBUCKET_BUILD_NUMBER'
            - source ./pipelines/executables/setup-ios-build.sh
            - echo "SENTRY_ENVIRONMENT=staging" >> .env
            - source ./pipelines/executables/ios-build-and-deploy-staging.sh

      - step:
          name: 'Deployment of supabase changes to production'
          caches:
            - yarn
            - node
          deployment: supabase-production
          trigger: 'manual'
          script:
            - export SUPABASE_DB_PASSWORD=$SUPABASE_DB_PASSWORD_PRODUCTION
            - export SUPABASE_PROJECT_ID=$SUPABASE_PROJECT_ID_PRODUCTION
            - source ./pipelines/executables/supabase-db-push.sh

      - step:
          name: 'Deployment of Backoffice web app to production'
          caches:
            - yarn
            - node
          deployment: backoffice-production
          trigger: 'manual'
          script:
            - source ./pipelines/executables/setup-backoffice-production-env.sh
            - source ./pipelines/executables/setup-backoffice-build.sh
            - vercel pull --yes --environment=production --token=$VERCEL_TOKEN
            - vercel build --prod --token=$VERCEL_TOKEN
            - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
