image: node:18

pipelines:
  default:
    - step:
        name: Backoffice lint and type checks
        script:
          - cd supabase
          - yarn install
          - yarn supabase-configs-backoffice true
          - cd ../BackofficeCMS
          - yarn install
          - yarn type-check
          - yarn lint

    - step:
        name: 'Deployment of Backoffice web app to preview'
        deployment: Staging
        script:
          - cd supabase
          - yarn install
          - yarn supabase-configs-backoffice
          - cd ../BackofficeCMS
          - yarn install
          - npm install --global vercel
          - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
          - vercel build --token=$VERCEL_TOKEN
          - vercel deploy --prebuilt  --token=$VERCEL_TOKEN

  branches:
    main:
      - step:
          name: Backoffice lint and type checks
          script:
            - cd supabase
            - yarn install
            - yarn supabase-configs-backoffice true
            - cd ../BackofficeCMS
            - yarn install
            - yarn type-check
            - yarn lint

      - step:
          name: 'Deployment of Backoffice web app to staging'
          deployment: Staging
          script:
            - cd supabase
            - yarn install
            - yarn supabase-configs-backoffice
            - npx supabase link --project-ref $SUPABASE_PROJECT_ID
            - npx supabase db push
            - cd ../BackofficeCMS
            - yarn install
            - npm install --global vercel
            - vercel pull --yes --token=$VERCEL_TOKEN
            - vercel build --token=$VERCEL_TOKEN
            - vercel deploy --prebuilt --token=$VERCEL_TOKEN

      - step:
          name: 'Deployment of Backoffice web app to production'
          deployment: Production
          trigger: 'manual'
          script:
            - cd supabase
            - yarn install
            - yarn supabase-configs-backoffice
            - npx supabase link --project-ref $SUPABASE_PROJECT_ID
            - npx supabase db push
            - cd ../BackofficeCMS
            - yarn install
            - npm install --global vercel
            - vercel pull --yes --environment=production --token=$VERCEL_TOKEN
            - vercel build --prod --token=$VERCEL_TOKEN
            - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
